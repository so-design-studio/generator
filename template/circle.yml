machine:
  python:
    version: 2.7.11
  node:
    version: 6.1.0
  # php:
  #   version: 7.0.7
  # ruby:
  #   version: ruby-2.3.1

dependencies:
  cache_directories:
    - front/node_modules
    - front/bower_components
    # - back/vendor
  post:
    - npm install -g bower
    - cd front && npm install && bower install
    - cd front && npm run build
    # - cd back && composer install
    # - cd back && bundle install && bundle package --all && bundle binstubs puma --path ./sbin
    # - cd back && sed -i -e 's/^BUNDLE_PATH.*$/BUNDLE_PATH: "vendor\/bundle"/g' .bundle/config
    # - cd back && bin/rails assets:precompile

    - mkdir deploy
    - cp -R front/public deploy/front
    - cp -R back deploy/back

    - git clone "git@github.com:so-design-studio/so-ops.git" $HOME/ops && $_/bin/deploy --prep

test:
  override:
    - cd front && npm test
    # - cd back && phpunit
    # - cd back && bin/rails test

deployment:
  production:
    branch: master
    commands:
      - $HOME/ops/bin/deploy production compute-@@SHORTNAME@@
  staging:
    branch: develop
    commands:
      - $HOME/ops/bin/deploy staging compute-staging

# see so-ops/bin/deploy for deployment strategies other than ansistrano
