machine:
  node:
    version: 5.6.0
  python:
    version: 2.7.10

  environment:
    DEPLOY_FROM_DIR: deploy
    DEPLOY_ANSIBLE_REPO_URL: "git@github.com:so-design-studio/so-ops.git"

dependencies:
  cache_directories:
    - front/node_modules
    - front/bower_components
  post:
    - npm install -g bower
    - cd assets && npm install && bower install
    - cd assets && npm run build

    - mkdir deploy
    - cp -R front/public deploy/front
    - cp -R back deploy/back

    - git clone "$DEPLOY_ANSIBLE_REPO_URL" $HOME/ansible && $_/deploy-prep.sh

test:
  override:
    - cd assets && npm test

deployment:
  production:
    branch: master
    commands:
      - $HOME/ansible/deploy.sh:
          environment:
            DEPLOY_TO_TAGS: craft
            DEPLOY_ENV:     production
  staging:
    branch: develop
    commands:
      - $HOME/ansible/deploy.sh:
          environment:
            DEPLOY_TO_TAGS: craft
            DEPLOY_ENV:     staging
